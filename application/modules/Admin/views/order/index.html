<?php include APP_PATH.'/public/admin/header_meta.html' ?>
<?php include APP_PATH.'/public/admin/header.html' ?>
<section id="main" data-layout="layout-1">
    <div class="modal fade" id="m-ud-article" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close close-modal" data-dismiss="modal" aria-hidden="true">
                        ×
                    </button>
                    <h4 class="modal-title" id="ModalLabel">
                        修改订单信息
                    </h4>
                </div>
                <div class="modal-body form-horizontal" style="height: 500px;overflow-y:auto;">
                    <form action="/admin/order/updateById" id="updateform" method="post">
                        <div class="form-group">
                            <label  class="col-sm-3 control-label">ID</label>
                            <label  class="col-sm-8 control-label" id="txt_uid" style="text-align: left;"></label>
                            <input type="hidden" name="id">
                        </div>
                        <div class="form-group">
                            <label for="upbname" class="col-sm-3 control-label">充值类型</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="upbname" name="bname" placeholder="充值类型">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="updateusername" class="col-sm-3 control-label">收货人姓名</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="upusername" class="form-control input-sm" name="username" placeholder="收货人姓名">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="updateusername" class="col-sm-3 control-label">电话</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="uptel" class="form-control input-sm" name="tel" placeholder="电话">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="updateuid" class="col-sm-3 control-label">用户id</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="upuid" class="form-control input-sm" name="uid" placeholder="电话">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="updateorder_id" class="col-sm-3 control-label">订单号</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="uporder_id" class="form-control input-sm" name="order_id" placeholder="订单号">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="nums" class="col-sm-3 control-label">购买数量</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="nums" class="form-control input-sm" name="nums" placeholder="数量">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="total" class="col-sm-3 control-label">充值数量</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="total" class="form-control input-sm" name="total" placeholder="数量">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="price" class="col-sm-3 control-label">单价</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="price" class="form-control input-sm" name="price" placeholder="单价">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="updateusername" class="col-sm-3 control-label">收货地址</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="upaddress" class="form-control input-sm" name="address" placeholder="收货地址">
                                </div>
                            </div>
                        </div>
						
                        <div class="form-group">
							<label for="sl_artType" class="col-sm-3 control-label">交易状态</label>
							<div class="col-sm-8">
								<select id="selectID"  name="status">
									<option value="0" text="0">等待确认</option>
									<option value="1" text="1">已付款</option>
									<option value="2" text="2">配送中</option>
									<option value="3" text="3">已完成</option>
									<option value="4" text="4">已撤销</option>
								</select>
							</div>
						</div>
						
						<div class="form-group">
                            <label for="updategathering" class="col-sm-3 control-label">充值地址</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="gathering" class="form-control input-sm" name="gathering" placeholder="充值地址">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="updatepayment" class="col-sm-3 control-label">用户钱包地址地址</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="payment" class="form-control input-sm" name="payment" placeholder="用户钱包地址地址">
                                </div>
                            </div>
                        </div>
						<div class="form-group">
                            <label for="updatepayhash" class="col-sm-3 control-label">交易哈希</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="pay_hash" class="form-control input-sm" name="pay_hash" placeholder="交易哈希">
                                </div>
                            </div>
                        </div>
						
						<fieldset id="status0" style="display:none">
							<legend>更新物流信息</legend>
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">配送方式</label>
							   <div class="col-sm-10">
								  <input class="form-control" id="modes" type="text" name="modeinfo[modes]" placeholder="配送方式"/>
							   </div>
							</div>
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">运费</label>
							   <div class="col-sm-10">
								  <input class="form-control" id="freight" type="text" name="modeinfo[freight]" placeholder="运费"/>
							   </div>
							</div>
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">物流公司</label>
							   <div class="col-sm-10">
								  <input class="form-control" id="lname" type="text" name="modeinfo[lname]" placeholder="物流公司"/>
							   </div>
							</div>
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">发货时间</label>
							   <div class="col-sm-10">
								  <input id="send_time" class="form-control" name="modeinfo[send_time]" placeholder="发货时间"/>
							   </div>
							</div>
							
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">支付时间</label>
							   <div class="col-sm-10">
								  <input id="pay_time" class="form-control" name="modeinfo[pay_time]" placeholder="支付时间"/>
							   </div>
							</div>
							
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">快递单号</label>
							   <div class="col-sm-10">
								  <input class="form-control" id="msorder" type="text" name="modeinfo[msorder]" placeholder="快递单号"/>
							   </div>
							</div>
						</fieldset>
						<fieldset  id="status2"  style="display:none">
							<fieldset  id="newinfo">
								<div class="form-group">
									<label for="disabledSelect"  class="col-sm-2 control-label">物流跟踪</label>
									<div class="col-sm-10" id="table">
										
									</div>
								</div>
							</fieldset>
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">收取时间</label>
							   <div class="col-sm-10">
								  <input id="meeting" class="form-control" name="logistics[newtime]" placeholder="快递收取时间"/>
							   </div>
							</div>
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">最新地址</label>
							   <div class="col-sm-10">
								  <input class="form-control" id="newaddress" type="text" name="logistics[newaddress]" placeholder="最新地址"/>
							   </div>
							</div>
							<div class="form-group">
							   <label for="disabledSelect"  class="col-sm-2 control-label">收取状态</label>
							   <div class="col-sm-10">
								  <input class="form-control" id="newstatus" type="text" name="logistics[newstatus]" placeholder="收取状态"/>
							   </div>
							</div>
							<div class="form-group">
								<label for="disabledSelect" class="col-sm-2 control-label">收货时间</label>
								<div class="col-sm-10">
									<input id="meeting" class="form-control" name="receivetime" placeholder="用户收货时间"/>
								</div>
							</div>
						</fieldset>
									
                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default waves-effect btn-update">修改</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" id="m-add-article" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close close-modal" data-dismiss="modal" aria-hidden="true">
                        ×
                    </button>
                    <h4 class="modal-title">
                        添加订单信息
                    </h4>
                </div>
                <div class="modal-body form-horizontal" style="height: 500px;overflow-y:auto;">
                    <form action="/admin/order/add" id="addform" method="post">
                        
                        <div class="form-group">
                            <label for="addName" class="col-sm-3 control-label">用户Email</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="addName" name="email" placeholder="用户Email">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addbname" class="col-sm-3 control-label">充值类型</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="addTitle" name="bname" placeholder="充值类型">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="username" class="col-sm-3 control-label">收货人姓名</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="username" class="form-control input-sm" name="username" placeholder="收货人姓名">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addtel" class="col-sm-3 control-label">电话</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="addKeywords" name="tel" placeholder="电话">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addorder_id" class="col-sm-3 control-label">订单号</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="addorder_id" name="order_id" placeholder="订单号">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="addnums" class="col-sm-3 control-label">购买数量</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="addorder_id" name="nums" placeholder="购买数量">
                                </div>
                            </div>
                        </div>
						<div class="form-group">
                            <label for="addtotal" class="col-sm-3 control-label">充值数量</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="addorder_id" name="total" placeholder="充值数量">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="price" class="col-sm-3 control-label">单价</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" id="price" class="form-control input-sm" name="price" placeholder="单价">
                                </div>
                            </div>
                        </div>
						
						<div class="form-group">
                            <label for="addaddress" class="col-sm-3 control-label">收货地址</label>
                            <div class="col-sm-8">
                                <div class="fg-line">
                                    <input type="text" class="form-control input-sm" id="address" name="address" placeholder="收货地址">
                                </div>
                            </div>
                        </div>
						
                        <div class="form-group">
							<label for="sl_artType" class="col-sm-3 control-label">交易状态</label>
							<div class="col-sm-8">
								<select id="selectID"  name="status">
									<option value="0" text="0">等待确认</option>
									<option value="1" text="1">已付款</option>
									<option value="2" text="2">配送中</option>
									<option value="3" text="3">已完成</option>
									<option value="4" text="4">已撤销</option>
								</select>
							</div>
						</div>
                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default waves-effect btn-insert">添加</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <aside id="sidebar" class="sidebar c-overflow toggled">
        <?php include APP_PATH.'/public/admin/menu_left.html' ?>
    </aside>
    <section id="content">
        <div class="container">
            <div id="myeditor"></div>
            <div class="card">
				<div class="card-header">
                    <h2>订单列表 <small>管理订单操作.</small></h2>
					<form action="/admin/order/excel" method="post">
					<div style="width: 200px;float: right;position: inherit;margin-top: -50px;"><input type="submit" value="导出Excel"></div>
					<form>
                </div>
                <div class="card-header">
                    <h2>订单列表 <small>管理订单操作.</small></h2>
                </div>
                <div class="table-responsive">
                    <table id="data-table-selection" class="table table-striped">
                        <thead>
                        <tr>
                            <th data-column-id="id" data-order="desc" data-type="numeric" data-identifier="true">订单编号</th>
                            <th data-column-id="uid">用户id</th>
                            <th data-column-id="bname">充值类型</th>
                            <th data-column-id="username">收货人姓名</th>
                            <th data-column-id="tel">电话</th>
                            <th data-column-id="order_id">订单号</th>
                            <th data-column-id="nums" >购买数量</th>
                            <th data-column-id="price" >单价</th>
                            <th data-column-id="total" >充值数量</th>
							<th data-column-id="email">Email</th>
							<th data-column-id="country">地区</th>
							<th data-column-id="c_time"  data-formatter="c_time">时间</th>
                            <th data-column-id="status" data-formatter="status" data-sortable="false">交易状态</th>
                            <th data-column-id="commands" data-formatter="commands" data-sortable="false">操作</th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </section>
</section>
<script>
    //全局变量
    require(['pathCnf'],function (pathCnf) {
        require(['bootgrid','bootstrapSelect','sweetAlert','summernote-zh','fileinput','jqueryform'],function () {
            $('.selectpicker').selectpicker({
                style: 'btn-default',
                size: 4
            });
            var grid=$("#data-table-selection").bootgrid({
                ajax: true,
                post: function ()
                {
                    /* To accumulate custom parameter with the request object */
                    return {
                        id: "b0df282a-0d67-40e5-8558-c9e93b7befed"
                    };
                },
                selection: true,
                multiSelect: true,
                rowSelect: true,
                keepSelection: true,
                url: "/admin/order/tabPage",
                responseHandler:function (data) {
                    var ret={
                        "current": data.data.current,
                        "rowCount": data.data.rowCount,
                        "rows":data.data.data,
                        "total": data.data.total
                    }
                    return ret;
                },
                templates: {
                    actions: '<div class="actions btn-group"><div class="dropdown btn-group"><button class="btn btn-default btn-add"><span class="zmdi zmdi-account-add zmdi-hc-fw"></span></button></div></div>',
                    actionButton:'<div class="dropdown btn-group"><button class="btn btn-default"><span class="zmdi zmdi-refresh zmdi-hc-fw"></span></button></div>'
                },
                formatters: {
					"c_time":function (column,row) {
                        return new Date(parseInt(row['c_time']) * 1000).toLocaleString().replace(/:\d{1,2}$/,' ');
                    },
                    "status":function (column, row) {
                        var str='';
                        switch (row.status){
                            case '0':
                                str='等待确认';
                                break;
                            case '1':
                                str='已付款';
                                break;
                            case '2':
                                str='配送中';
                                break;
                            case '3':
                                str='已完成';
                                break;
							case '4':
                                str='已撤销';
                                break;
                        }
                        return str;
                    },
                    "commands": function(column, row)
                    {
                        var btn_publish=("<?php if(unserialize($_SESSION['user']['permission'])['is_administortar']==1){ echo '<button type=\"button\" class=\"btn btn-icon bgm-white waves-effect waves-circle btn_publish\" data-row-id=\"" + row.id + "\"><span class=\"zmdi zmdi-tv-alt-play zmdi-hc-fw\"></span></button>'; }?>");

                        var btn_edit=("<?php if(unserialize($_SESSION['user']['permission'])['is_administortar']==1){ echo '<button type=\"button\" class=\"btn btn-icon bgm-white waves-effect waves-circle btn_update\" data-row-id=\"" + row.id + "\"><span class=\"zmdi zmdi-edit\"></span></button>'; }?>");

                        var btn_delete=("<?php if(unserialize($_SESSION['user']['permission'])['is_administortar']==1){ echo '<button type=\"button\" class=\"btn btn-icon bgm-white waves-effect waves-circle btn_delete\" data-row-id=\"" + row.id + "\"><span class=\"zmdi zmdi-delete\"></span></button>'; }?>");

                        return btn_edit+btn_delete;
                    }
                }
            }).on('loaded.rs.jquery.bootgrid',function () {
                grid.find('.btn_update').on('click',function (e) {
                    var target=e.target.tagName=="BUTTON"?$(e.target):$(e.target).parent();
                    $('#txt_uid').text(target.attr('data-row-id'));
                    $.ajax({
                        type:"get",
                        url:"/admin/order/getArticleById",
                        data:{'id':target.attr('data-row-id')},
                        async:true,
                        dataType:'json',
                        beforeSend:function () {
                            $("#m-ud-article").find('.modal-body').ajax_loader({size:'pl-lg',color:'pls-green'});
                        },
                        complete:function () {
                            setTimeout(function () {
                                $("#m-ud-article").find('.ajax-loader').fadeOut();
                            },100);
                        },
                        success:function (data) {
                            if(data.code==0){
                                $("#updateform .fileinput-preview").html('');
                                $('#updateform input[name=id]').val(data.data.id);
                                $('#updateform #upbname').val(data.data.bname);
                                $('#updateform #upusername').val(data.data.username);
                                $('#updateform #uporder_id').val(data.data.order_id);
                                $('#updateform #upuid').val(data.data.uid);
                                $('#updateform #nums').val(data.data.nums);
                                $('#updateform #price').val(data.data.price);
                                $('#updateform #total').val(data.data.total);
                                $('#updateform #uptel').val(data.data.tel);
                                $('#updateform #upaddress').val(data.data.country+'——'+data.data.address);
                                $('#updateform #gathering').val(data.data.gathering);
                                $('#updateform #payment').val(data.data.payment);
                                $('#updateform #pay_hash').val(data.data.pay_hash);
                                $('#updateform #modes').val(data.data.modeinfo.modes);
                                $('#updateform #freight').val(data.data.modeinfo.freight);
                                $('#updateform #lname').val(data.data.modeinfo.lname);
                                $('#updateform #send_time').val(data.data.modeinfo.send_time);
                                $('#updateform #pay_time').val(data.data.modeinfo.pay_time);
                                $('#updateform #msorder').val(data.data.modeinfo.msorder);
								$('#updateform input[name=receivetime]').val(data.data.receivetime);
								$("#updateform #selectID option[value='"+data.data.status+"']").attr("selected",true);
								//$("#updateform #selectID").find("option:text('2')").attr("selected",true);
								if(data.data.status==0 || data.data.status==1){
									$("#updateform #status0").show();
								}
								if(data.data.status==2 || data.data.status==3){
									//if(JSON.stringify(data.data.logistics)!='{}'){
										var strs='';
										//console.log(data.data.logistics);
										$.each(data.data.logistics,function(k,v){
											strs+='<table  class="table table-striped">';
											strs+='<thead>';
											strs+='<tr>';
											strs+='<th>时间：'+v.newtime+'—最新地址：'+v.newaddress+'—收取状态：'+v.newstatus+'—配送公司：'+data.data.modeinfo.lname+'—快递单号：'+data.data.modeinfo.msorder+'</th>';
											strs+='</tr>';
											strs+='</thead>';
											strs+='<tbody>';
											strs+='</tbody>';
											strs+='</table>';
										});
										
										$("#updateform #newinfo #table").html(strs);
									//}
									$("#updateform #status2").show();
								}
                            }
                        }
                    });
                    $("#m-ud-article").modal('show');
                });
                grid.find('.btn_delete').on('click',function (e) {
                    var id=$(this).attr('data-row-id');
                    swal({
                        title: "你将要删除这个新闻记录吗?",
                        text: "如果你删除了,将无法恢复!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "delete",
                        closeOnConfirm: false
                    }, function(){
                        $.ajax({
                            type:"post",
                            url:"/admin/order/delete",
                            data:{'id':id},
                            async:true,
                            dataType:'json',
                            beforeSend:function () {
                                $("#data-table-selection").ajax_loader({size:'pl-lg',color:'pls-green'});
                            },
                            complete:function () {
                                setTimeout(function () {
                                    $("#data-table-selection").find('.ajax-loader').fadeOut();
                                },100);
                            },
                            success:function (data) {
                                if(data.code=='0'){
                                    swal("已删除!", "当前新闻记录已删除.", "success");
                                    $("#data-table-selection").bootgrid("reload");
                                }else if(data.code=='3'){
                                    swal('操作失败','没有权限,请联系管理员!');
                                }else{
                                    swal('操作失败');
                                }
                            }
                        })

                    });
                });
                grid.find('.btn_search').on('click',function (e) {
                    var id=$(this).attr('data-row-id');
                    window.open("../order/item?id="+id);
                })
            });
            $("body").on('click',function (e) {
                if(e.target.className.indexOf('btn-update')>0){
                    //$('input[name=content]').val(Base64.encode($('#updateContent').summernote('code')));
                    var options={
                        dataType:'json',
                        success:function (data) {
                            if(data.code=='0'){
								$("#updateform")[0].reset();
                                $("#m-ud-article").modal("hide");
                                $("#data-table-selection").bootgrid("reload");
                            }else if(data.code=='1002'){
                                swal(data.msg);
                            }else if(data.code=='3'){
                                swal('操作失败','没有权限,请联系管理员!');
                            }else{
                                swal('操作失败');
                            }
                        }
                    };
                    $("#updateform").ajaxSubmit(options);
                }
//                m-add-article
                //打开添加按钮
                if(e.target.tagName=='BUTTON'||e.target.tagName=='SPAN'){
                    if(e.target.className.indexOf('btn-add')>0||e.target.parentNode.className.indexOf('btn-add')>0){
                        $("#m-add-article").modal("show");

                        var $summernote=$('#addContent').summernote({
                            height: 250,
                            lang: 'zh-CN',
                            callbacks: {
                                onImageUpload: function(files) {
                                    sendFile($summernote,files[0],articleId);
                                }
                            }
                        });
                        $("#sl_artType").selectpicker('val',0);
                        $('#addContent').summernote('code','');
                    }
                }
                //添加按钮
                if(e.target.className.indexOf('btn-insert')>0){
                    //$('#hiddenContent').val(Base64.encode($('#updateContent').summernote('code')));
                    var options={
                        dataType:'json',
                        success:function (data) {
                            $("#addform")[0].reset();
                            if(data.code=='0'){
                                $("#m-add-article").modal("hide");
                                $("#data-table-selection").bootgrid("reload");
                            }else if(data.code=='3'){
                                swal('操作失败','没有权限,请联系管理员!');
                            }else{
                                swal('操作失败');
                            }
                        }
                    };
                    $("#addform").ajaxSubmit(options);
                }
            })
        });
    });
    function sendFile($summernote,file,artId) {
        oMyForm = new FormData();
        oMyForm.append("file", file);
        if(artId){
            oMyForm.append("artId",artId);
        }
        oMyForm.append("type","1");
        oMyForm.append("from","2");
        var fileData = URL.createObjectURL(file);
        $summernote.summernote('insertImage', fileData,function ($image) {
            $.ajax({
                url: "/admin/order/uploadimg",
                data: oMyForm,
                cache: false,
                contentType: false,
                processData: false,
                dataType:"json",
                type: 'POST',
                success: function(data){
		    console.log('img',data);
                    if(data.code==0) {
                        $image.attr('src', data.data);
                    }else if(data.code=='3') {
                        swal('操作失败', '没有权限,请联系管理员!');
                    }else {
                        swal('操作失败');
                    }
                }
            });

        });
    }
</script>
<?php include APP_PATH.'/public/admin/footer.html' ?>
