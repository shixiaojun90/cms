<?php include APP_PATH.'/public/admin/header_meta.html' ?>
<?php include APP_PATH.'/public/admin/header.html' ?>
<style>
	.toggle-switch .ts-label{
		width: 130px;
	}
</style>
<section id="main" data-layout="layout-1">
	<div class="modal fade" id="m-ud-userinfo" tabindex="-1" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close close-modal" data-dismiss="modal" aria-hidden="true">
						×
					</button>
					<h4 class="modal-title" id="ModalLabel">
						修改权限信息
					</h4>
				</div>
				<div class="modal-body form-horizontal">
					<div class="form-group">
						'<label  class="col-sm-3 control-label">角色ID</label>
						<label  class="col-sm-8 control-label" id="txt_roleId" style="text-align: left;"></label>
					</div>
					<div class="form-group">
						<label for="inputRoleName" class="col-sm-3 control-label">角色名称</label>
						<div class="col-sm-8">
							<div class="fg-line">
								<input type="text" class="form-control input-sm" id="inputRoleName" placeholder="昵称">
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="sl_type" class="col-sm-3 control-label">角色类型</label>
						<div class="col-sm-8">
							<select class="selectpicker" id="sl_type">
								<?php foreach($rolegroup as $key=>$val){ ?>
								<option value="<?php echo $val['id']?>"><?php echo $val['group_name']?></option>
								<?php }?>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label  class="col-sm-3 control-label">权限</label>
						<div class="col-sm-8 role_list">

						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default waves-effect btn-update">修改</button>
					<button type="button"  class="btn btn-default close-modal" data-dismiss="modal">
						关闭
					</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->


	<div class="modal fade" id="m-add-info" tabindex="-1" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close close-modal" data-dismiss="modal" aria-hidden="true">
						×
					</button>
					<h4 class="modal-title">
						添加权限信息
					</h4>
				</div>
				<div class="modal-body form-horizontal">
					<div class="form-group">
						<label for="addRoleName" class="col-sm-3 control-label">角色名称</label>
						<div class="col-sm-8">
							<div class="fg-line">
								<input type="text" class="form-control input-sm" id="addRoleName" placeholder="昵称">
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="add_sl_type" class="col-sm-3 control-label">角色类型</label>
						<div class="col-sm-8">
							<select class="selectpicker" id="add_sl_type">
								<?php foreach($rolegroup as $key=>$val){ ?>
								<option value="<?php echo $val['id']?>"><?php echo $val['group_name']?></option>
								<?php }?>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label  class="col-sm-3 control-label">权限</label>
						<div class="col-sm-8 role_list">

						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default waves-effect btn-insert">添加</button>
					<button type="button"  class="btn btn-default close-modal" data-dismiss="modal">
						关闭
					</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	<aside id="sidebar" class="sidebar c-overflow toggled">
		<?php include APP_PATH.'/public/admin/menu_left.html' ?>
	</aside>
	<section id="content">
		<div class="container">
			<div class="card">
				<div class="card-header">
					<h2>角色权限信息 <small>管理所有用户角色权限等操作.</small></h2>
				</div>
				<div class="table-responsive">
					<table id="data-table-selection" class="table table-striped">
						<thead>
						<tr>
							<th data-column-id="id" data-order="asc" data-type="numeric" data-identifier="true">ID</th>
							<th data-column-id="group_name">角色组别</th>
							<th data-column-id="role_name" >角色</th>
							<th data-column-id="permission" data-formatter="permission">权限</th>
							<th data-column-id="commands" data-formatter="commands" data-sortable="false">操作</th>
						</tr>
						</thead>
						<tbody>

						</tbody>
					</table>
				</div>

			</div>
		</div>
	</section>
</section>
<script>
	//全局变量
	var permission_info=JSON.parse('<?php echo $global; ?>');
	require(['pathCnf'],function (pathCnf) {
		require(['bootgrid','bootstrapSelect','sweetAlert'],function () {
			$('.selectpicker').selectpicker({
				style: 'btn-default',
				size: 4
			});
			var grid=$("#data-table-selection").bootgrid({
				ajax: true,
				post: function ()
				{
					/* To accumulate custom parameter with the request object */
					return {
						id: "b0df282a-0d67-40e5-8558-c9e93b7befed"
					};
				},
				url: "/admin/roleinfo/tabPage",
				responseHandler:function (data) {
					var ret={
						"current": data.data.current,
						"rowCount": data.data.rowCount,
						"rows":data.data.data,
						"total": data.data.total
					}
					return ret;
				},
				templates: {
					actions: '<div class="actions btn-group"><div class="dropdown btn-group"><button class="btn btn-default btn-add"><span class="zmdi zmdi-account-add zmdi-hc-fw"></span></button></div></div>',
					actionButton:'<div class="dropdown btn-group"><button class="btn btn-default"><span class="zmdi zmdi-refresh zmdi-hc-fw"></span></button></div>'
				},
				formatters: {
					"commands": function(column, row)
					{
						var btn_edit=("<?php if(unserialize($_SESSION['user']['permission'])['is_administortar']==1){ echo '<button type=\"button\" class=\"btn btn-icon bgm-white waves-effect waves-circle btn_update\" data-row-id=\"" + row.id + "\"><span class=\"zmdi zmdi-edit\"></span></button>'; }?>");

						var btn_delete=("<?php if(unserialize($_SESSION['user']['permission'])['is_administortar']==1){ echo '<button type=\"button\" class=\"btn btn-icon bgm-white waves-effect waves-circle btn_delete\" data-row-id=\"" + row.id + "\"><span class=\"zmdi zmdi-delete\"></span></button>'; }?>");
						return btn_edit +btn_delete;
					},
                    permission:function (column,row) {
                        return JSON.stringify(row['permission']);
                    }
				}
			}).on('loaded.rs.jquery.bootgrid',function () {
				grid.find('.btn_update').on('click',function (e) {
					var target=e.target.tagName=="BUTTON"?$(e.target):$(e.target).parent();
					$('#txt_roleId').text(target.attr('data-row-id'));
					$.ajax({
						type:"get",
						url:"/admin/roleinfo/getRoleinfoById",
						data:{'roleId':target.attr('data-row-id')},
						async:true,
						dataType:'json',
						beforeSend:function () {
							$("#m-ud-userinfo").find('.modal-body').ajax_loader({size:'pl-lg',color:'pls-green'});
						},
						complete:function () {
							setTimeout(function () {
								$("#m-ud-userinfo").find('.ajax-loader').fadeOut();
							},100);
						},
						success:function (data) {
							if(data.code=='0'){
								$("#inputRoleName").val(data.data.role_name);
								$("#sl_type").selectpicker('val',data.data['group_id']);
								var permission=data.data.permission;
								$("#m-ud-userinfo").find(".role_list").html("");
								for(var k in permission){
									var btn_switch='<div class="col-sm-6 m-t-5">'+
											'<div class="toggle-switch" data-ts-color="green">'+
											'<label for="'+k+'" class="ts-label">'+k+'</label>'+
											'<input id="'+k+'" type="checkbox" value="off" hidden="hidden">'+
											'<label for="'+k+'" class="ts-helper"></label>'+
											'</div>'+
											'</div>';
									$("#m-ud-userinfo").find(".role_list").append(btn_switch);
								}
								for(var kk in permission){
									if(permission[kk]==1){
										$("#"+kk).attr('checked','checked');
										$("#"+kk).val('on');
									}else{
										$("#"+kk).val('off');
									}
								}
								$('body').on('change', 'input:checkbox', function () {
									if ($(this).is(':checked')) {
										$(this).val('on');
									}else{
										$(this).val('off');
									}
								})
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown) {
							alert(XMLHttpRequest.status);
							alert(XMLHttpRequest.readyState);
							alert(textStatus);
						}
					});
					$("#m-ud-userinfo").modal('show');
				});

				grid.find('.btn_delete').on('click',function (e) {
					var roleId=$(this).attr('data-row-id');
					swal({
						title: "你将要删除这个角色吗?",
						text: "如果你删除了,将无法恢复!",
						type: "warning",
						showCancelButton: true,
						confirmButtonColor: "#DD6B55",
						confirmButtonText: "delete",
						closeOnConfirm: false
					}, function(){
						$.ajax({
							type:"post",
							url:"/admin/roleinfo/delete",
							data:{'roleId':roleId},
							async:true,
							dataType:'json',
							beforeSend:function () {
								$("#data-table-selection").ajax_loader({size:'pl-lg',color:'pls-green'});
							},
							complete:function () {
								setTimeout(function () {
									$("#data-table-selection").find('.ajax-loader').fadeOut();
								},100);
							},
							success:function (data) {
								if(data.code=='0'){
									swal("已删除!", "当前角色已删除.", "success");
									$("#data-table-selection").bootgrid("reload");
								}else if(data.code=='3'){
									swal('操作失败','没有权限,请联系管理员!');
								}else{
									swal('操作失败');
								}
							}
						})

					});
				});
			});
			$("body").on('click',function (e) {
				if(e.target.className.indexOf('btn-update')>0){
					var dt={};
					$('#inputRoleName').val()?dt['role_name']=$('#inputRoleName').val():'';
					$('#sl_type').val()?dt['group_id']=$('#sl_type').val():'';
					var permission={};
					$("#m-ud-userinfo").find(".role_list").find('input:checkbox').each(function () {
						permission[$(this).prop('id')]=$(this).val()=="on"?'1':'0';
					})
					dt['permission']=permission;
					$.ajax({
						type:"post",
						url:"/admin/roleinfo/updatePermissionByRoleID",
						data:{'roleId':$("#txt_roleId").text().trim(),'data':dt},
						async:true,
						dataType:'json',
						beforeSend:function () {
							$("#m-ud-userinfo").find('.modal-body').ajax_loader({size:'pl-lg',color:'pls-green'});
						},
						complete:function () {
							setTimeout(function () {
								$("#m-ud-userinfo").find('.ajax-loader').fadeOut();
							},100);
						},
						success:function (data) {
							if(data.code=='0'){
								$("#m-ud-userinfo").modal('hide');
								$("#data-table-selection").bootgrid("reload");
							}else if(data.code=='3'){
								swal('操作失败','没有权限,请联系管理员!');
							}else{
								swal('操作失败');
							}
						}
					})
				}
				//打开添加按钮
				if(e.target.tagName=='BUTTON'||e.target.tagName=='SPAN'){
					if(e.target.className.indexOf('btn-add')>0||e.target.parentNode.className.indexOf('btn-add')>0){
						$("#m-add-info").modal("show");
						$("#m-add-info .role_list").html("");
						for(var k in permission_info['permission']){
							var btn_switch='<div class="col-sm-6 m-t-5">'+
									'<div class="toggle-switch" data-ts-color="green">'+
									'<label for="add_'+k+'" class="ts-label">'+k+'</label>'+
									'<input id="add_'+k+'" type="checkbox" value="off" hidden="hidden">'+
									'<label for="add_'+k+'" class="ts-helper"></label>'+
									'</div>'+
									'</div>';
							$("#m-add-info .role_list").append(btn_switch);
						}
					}
				}
				//添加按钮
				if(e.target.className.indexOf('btn-insert')>0){
					var add_dt={};
                    var permission={};
                    $("#m-add-info").find(".role_list").find('input:checkbox').each(function () {
                        permission[$(this).prop('id')]=$(this).val()=="on"?'1':'0';
                    })
					console.log(permission);
					add_dt['permission']=permission;
					add_dt['role_name']=$('#addRoleName').val();
					add_dt['group_id']=$('#add_sl_type').val()
					$.ajax({
						type:"post",
						url:"/admin/roleinfo/add",
						data:{'data':add_dt},
						async:true,
						dataType:'json',
						beforeSend:function () {
							$("#m-add-info").find('.modal-body').ajax_loader({size:'pl-lg',color:'pls-green'});
						},
						complete:function () {
							setTimeout(function () {
								$("#m-add-info").find('.ajax-loader').fadeOut();
							},100);
						},
						success:function (data) {
							if(data.code=='0'){
								$("#m-add-info").modal('hide');
								$("#data-table-selection").bootgrid("reload");
							}else if(data.code=='3'){
								swal('操作失败','没有权限,请联系管理员!');
							}else{
								swal('操作失败');
							}
						}
					})
				}

			})
		});
	});
</script>
<?php include APP_PATH.'/public/admin/footer.html' ?>